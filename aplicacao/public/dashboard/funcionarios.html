<!DOCTYPE html>
<html lang="ptbr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOBANKING</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="shortcut icon" href="../imagens/logo.ico" type="image/x-icon">
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/funcionarios.css">
    <link rel="stylesheet" href="../css/mensagemCard.css">
    <link rel="stylesheet" href="../css/default.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body onload="listarFuncionarios(), listarTiposUsuarios()">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>


    <div id="frame" class="frame-aplicacao" style="display: flex;">
        <nav class="menu-lateral">
            <h2 class="titulo-menu">Menu</h2>
            <ul id="menuLateralBox">
                <li>
                    <a href="card.html">
                        <span class="icon-menu"><i class="fa-solid fa-server"></i></span>
                        <span class="titulo-link-menu">Máquinas</span>
                    </a>
                </li>
                <li>
                    <a href="dashboard.html">
                        <span class="icon-menu"><i class="fa-solid fa-chart-simple"></i></span>
                        <span class="titulo-link-menu">Gráficos</span>
                    </a>
                </li>

                <li>
                    <a href="alertas.html">
                        <span class="icon-menu"><i class="fa-solid fa-triangle-exclamation"></i></span>
                        <span class="titulo-link-menu">Alertas</span>
                    </a>
                </li>
            </ul>
            <div class="name-menu">
                <a href="usuarioInfo.html">
                    <h2 id="nome_perfil_menu"></h2>
                </a>
            </div>
            <a class="buttonSair-menu" href="../index.html">
                <h2 id="">Sair</h2>
            </a>
        </nav>
        <div class="conteudo">
            <h1>Funcionários</h1>
            <button onclick="modalAddUser()" class="botao-adicionar"> <img src="../imagens/Plus.svg" alt="">
                <p>Adicionar</p>
            </button>

            <div id="listagemFuncionario" class="lista">

            </div>


        </div>
    </div>
    <div class="modalAddUser" id="modalAddUser">
        <div class="title-box">
            <h2>Adicionar usuário</h2>
            <i onclick="fecharModalAddUser()" id="closeModal" class="fa-solid fa-x"></i>
        </div>
        <div class="form-box-pai">

            <div class="form">

                <form action="">
                    <label for="nome">
                        Nome do Funcionário:
                        <input type="text" id="nome_input" placeholder="Nome...">
                    </label>


                    <label for="email">
                        Email:
                        <input type="email" id="email_input" placeholder="exemplo@gmail.com">
                    </label>

                    <label for="senha">
                        Senha:
                        <input type="text" id="senha_input" placeholder="••••••••••">
                    </label>

                    <label for="cpf">
                        CPF:
                        <input type="number" maxlength="11" id="cpf_input" placeholder="XXX.XXX.XXX-XX">
                    </label>

                    <label for="telefone">
                        Perfil
                        <select name="" id="select_nivel">

                        </select>
                    </label>

                </form>

            </div>
            <div>
                <button onclick="adicionarUsuario()">Adicionar</button>
            </div>
        </div>
    </div>
    <div class="modalAddUser" id="modalEditUser">
        <div class="title-box">
            <h2>Editar Usuário</h2>
            <i onclick="fecharModalEditUser()" id="closeModal" class="fa-solid fa-x"></i>
        </div>
        <div class="form-box-pai">

            <div class="form">

                <form action="">
                    <label for="nome">
                        Nome do Funcionário:
                        <input type="text" id="nomeFuncEdit">
                    </label>


                    <label for="telefone">
                        Email:
                        <input type="text" id="emailFuncEdit">
                    </label>

                    <label for="senha">
                        Senha:
                        <input type="text" id="senhaFuncEdit">
                    </label>

                    <label for="cpf">
                        CPF:
                        <input type="number" maxlength="11" id="cpfFuncEdit">
                    </label>

                    <label for="telefone">
                        Perfil
                        <select name="" id="selectNvEdit">

                        </select>
                    </label>

                </form>

            </div>
            <div>
                <button onclick="editarUsuario()">Editar</button>
            </div>
        </div>
    </div>


    <!-- CARD DE SUCESSO -->

    <div id="cardSucessoMsg" class="cardMensagem fecharCardMensagem">
        <svg class="wave" viewBox="0 0 1440 320" xmlns="http://www.w3.org/2000/svg">
            <path
                d="M0,256L11.4,240C22.9,224,46,192,69,192C91.4,192,114,224,137,234.7C160,245,183,235,206,213.3C228.6,192,251,160,274,149.3C297.1,139,320,149,343,181.3C365.7,213,389,267,411,282.7C434.3,299,457,277,480,250.7C502.9,224,526,192,549,181.3C571.4,171,594,181,617,208C640,235,663,277,686,256C708.6,235,731,149,754,122.7C777.1,96,800,128,823,165.3C845.7,203,869,245,891,224C914.3,203,937,117,960,112C982.9,107,1006,181,1029,197.3C1051.4,213,1074,171,1097,144C1120,117,1143,107,1166,133.3C1188.6,160,1211,224,1234,218.7C1257.1,213,1280,139,1303,133.3C1325.7,128,1349,192,1371,192C1394.3,192,1417,128,1429,96L1440,64L1440,320L1428.6,320C1417.1,320,1394,320,1371,320C1348.6,320,1326,320,1303,320C1280,320,1257,320,1234,320C1211.4,320,1189,320,1166,320C1142.9,320,1120,320,1097,320C1074.3,320,1051,320,1029,320C1005.7,320,983,320,960,320C937.1,320,914,320,891,320C868.6,320,846,320,823,320C800,320,777,320,754,320C731.4,320,709,320,686,320C662.9,320,640,320,617,320C594.3,320,571,320,549,320C525.7,320,503,320,480,320C457.1,320,434,320,411,320C388.6,320,366,320,343,320C320,320,297,320,274,320C251.4,320,229,320,206,320C182.9,320,160,320,137,320C114.3,320,91,320,69,320C45.7,320,23,320,11,320L0,320Z"
                fill-opacity="1"></path>
        </svg>

        <div class="icon-container">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" stroke-width="0" fill="currentColor"
                stroke="currentColor" class="icon">
                <path
                    d="M256 48a208 208 0 1 1 0 416 208 208 0 1 1 0-416zm0 464A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209c9.4-9.4 9.4-24.6 0-33.9s-24.6-9.4-33.9 0l-111 111-47-47c-9.4-9.4-24.6-9.4-33.9 0s-9.4 24.6 0 33.9l64 64c9.4 9.4 24.6 9.4 33.9 0L369 209z">
                </path>
            </svg>
        </div>
        <div class="message-text-container">
            <p class="message-text">Mensagem de sucesso</p>
            <p class="sub-text" id="descCardSucesso"></p>
        </div>
        <svg onclick="fecharCardSucessoMensagem()" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15 15"
            stroke-width="0" fill="none" stroke="currentColor" class="cross-icon">
            <path fill="currentColor"
                d="M11.7816 4.03157C12.0062 3.80702 12.0062 3.44295 11.7816 3.2184C11.5571 2.99385 11.193 2.99385 10.9685 3.2184L7.50005 6.68682L4.03164 3.2184C3.80708 2.99385 3.44301 2.99385 3.21846 3.2184C2.99391 3.44295 2.99391 3.80702 3.21846 4.03157L6.68688 7.49999L3.21846 10.9684C2.99391 11.193 2.99391 11.557 3.21846 11.7816C3.44301 12.0061 3.80708 12.0061 4.03164 11.7816L7.50005 8.31316L10.9685 11.7816C11.193 12.0061 11.5571 12.0061 11.7816 11.7816C12.0062 11.557 12.0062 11.193 11.7816 10.9684L8.31322 7.49999L11.7816 4.03157Z"
                clip-rule="evenodd" fill-rule="evenodd"></path>
        </svg>
    </div>

    <!-- CARD DE ERRO -->
    <div id="cardErroMsg" class="cardMensagem fecharCardMensagem">
        <svg class="waveErro" viewBox="0 0 1440 320" xmlns="http://www.w3.org/2000/svg">
            <path
                d="M0,256L11.4,240C22.9,224,46,192,69,192C91.4,192,114,224,137,234.7C160,245,183,235,206,213.3C228.6,192,251,160,274,149.3C297.1,139,320,149,343,181.3C365.7,213,389,267,411,282.7C434.3,299,457,277,480,250.7C502.9,224,526,192,549,181.3C571.4,171,594,181,617,208C640,235,663,277,686,256C708.6,235,731,149,754,122.7C777.1,96,800,128,823,165.3C845.7,203,869,245,891,224C914.3,203,937,117,960,112C982.9,107,1006,181,1029,197.3C1051.4,213,1074,171,1097,144C1120,117,1143,107,1166,133.3C1188.6,160,1211,224,1234,218.7C1257.1,213,1280,139,1303,133.3C1325.7,128,1349,192,1371,192C1394.3,192,1417,128,1429,96L1440,64L1440,320L1428.6,320C1417.1,320,1394,320,1371,320C1348.6,320,1326,320,1303,320C1280,320,1257,320,1234,320C1211.4,320,1189,320,1166,320C1142.9,320,1120,320,1097,320C1074.3,320,1051,320,1029,320C1005.7,320,983,320,960,320C937.1,320,914,320,891,320C868.6,320,846,320,823,320C800,320,777,320,754,320C731.4,320,709,320,686,320C662.9,320,640,320,617,320C594.3,320,571,320,549,320C525.7,320,503,320,480,320C457.1,320,434,320,411,320C388.6,320,366,320,343,320C320,320,297,320,274,320C251.4,320,229,320,206,320C182.9,320,160,320,137,320C114.3,320,91,320,69,320C45.7,320,23,320,11,320L0,320Z"
                fill-opacity="1"></path>
        </svg>

        <div class="icon-containerErro">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" stroke-width="0" fill="currentColor"
                stroke="currentColor" class="iconErro">
                <path
                    d="M256 48a208 208 0 1 1 0 416 208 208 0 1 1 0-416zm0 464A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209c9.4-9.4 9.4-24.6 0-33.9s-24.6-9.4-33.9 0l-111 111-47-47c-9.4-9.4-24.6-9.4-33.9 0s-9.4 24.6 0 33.9l64 64c9.4 9.4 24.6 9.4 33.9 0L369 209z">
                </path>
            </svg>
        </div>
        <div class="message-text-container">
            <p class="message-textErro">Mensagem de erro</p>
            <p class="sub-text" id="descCardErro"></p>
        </div>
        <svg onclick="fecharCardErroMensagem()" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15 15" stroke-width="0"
            fill="none" stroke="currentColor" class="cross-icon">
            <path fill="currentColor"
                d="M11.7816 4.03157C12.0062 3.80702 12.0062 3.44295 11.7816 3.2184C11.5571 2.99385 11.193 2.99385 10.9685 3.2184L7.50005 6.68682L4.03164 3.2184C3.80708 2.99385 3.44301 2.99385 3.21846 3.2184C2.99391 3.44295 2.99391 3.80702 3.21846 4.03157L6.68688 7.49999L3.21846 10.9684C2.99391 11.193 2.99391 11.557 3.21846 11.7816C3.44301 12.0061 3.80708 12.0061 4.03164 11.7816L7.50005 8.31316L10.9685 11.7816C11.193 12.0061 11.5571 12.0061 11.7816 11.7816C12.0062 11.557 12.0062 11.193 11.7816 10.9684L8.31322 7.49999L11.7816 4.03157Z"
                clip-rule="evenodd" fill-rule="evenodd"></path>
        </svg>
    </div>

</body>

</html>

<script>

    const menuLaterealHTML = document.getElementById('menuLateralBox')
    var sessTipoUsuario = sessionStorage.ID_TIPO_USUARIO
    if (sessTipoUsuario == 1) {
        menuLaterealHTML.innerHTML += `
     <li>
          <a href="funcionarios.html">
            <span class="icon-menu"><i class="fa-solid fa-user"></i></span>
            <span class="titulo-link-menu">Funcionários</span>
          </a>
        </li>
    `
    }

    nome_perfil_menu.innerHTML = sessionStorage.NOME_USUARIO

    function modalAddUser() {

        const modal = document.getElementById('modalAddUser')

        modal.style.display = 'block'
        const frame = document.getElementById('frame');
        frame.classList.add('blur-grid')

    }

    function fecharModalAddUser() {

        const modal = document.getElementById('modalAddUser')

        modal.style.display = 'none'
        const frame = document.getElementById('frame');
        frame.classList.remove('blur-grid')
    }

    function fecharModalEditUser() {

        const modal = document.getElementById('modalEditUser')

        modal.style.display = 'none'
        const frame = document.getElementById('frame');
        frame.classList.remove('blur-grid')
    }

    var idEmpresa = sessionStorage.ID_EMPRESA


    function listarFuncionarios() {
        var idUsuarioListFun = sessionStorage.ID_USUARIO
        // A var idUsuarioListFun se torna 
        fetch(`/usuarios/listarFuncionarios/${idEmpresa}/${idUsuarioListFun}`, {
            method: "GET",
        })
            .then(function (resposta) {
                if (resposta.status == 204) {

                    listagemFuncionario.innerHTML = "Nenhum resultado encontrado."

                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then((funcionarios) => {

                    funcionarios.forEach((registro) => {

                        listagemFuncionario.innerHTML += `
                        
                <div class="container">

                    <div class="nome">
                        <p>${registro.nomeUsuario}</p>
                    </div>
                    <div class="centro">
                        <div class="status">
                            <span>CPF:</span>
                            <p>${registro.cpfUsuario}</p>
                        </div>
                        <div class="status">
                            <span>Email:</span>
                            <p>${registro.emailUsuario}</p>
                        </div>
                        <div class="status">
                            <span>Tipo:</span>
                            <p>${registro.tipoUsuario}</p>
                        </div>
                    </div>
                    <div class="opcoes">
                        <i class="fa-solid fa-trash" id="trash" onclick="removerUsuario(${registro.idUsuario})"></i>       
                        <i class="fa-solid fa-pencil" id="pencil" onclick="abrirModalEditADM(${registro.idUsuario})"></i>
                    </div>

                </div>
            
            `;
                    });
                });
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }


    function listarTiposUsuarios() {
        fetch(`/usuarios/listarTipoUsuario`, {
            method: "GET",
        })
            .then(function (resposta) {
                resposta.json().then((tipoUsuario) => {

                    tipoUsuario.forEach((registro) => {

                        select_nivel.innerHTML += `
                        
                <option value="${registro.id}">${registro.tipo}</option>
            
            `;

                        selectNvEdit.innerHTML += `
                        
                        <option value="${registro.id}">${registro.tipo}</option>
                    
            `;

                    });
                });
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }



    let emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    let cpfRegex = /^\d{11}$/;

    function adicionarUsuario() {
        var nomeVar = nome_input.value;
        var emailVar = email_input.value;
        var senhaVar = senha_input.value;
        var nivelVar = select_nivel.value;
        var cpfVar = cpf_input.value;


        if (nomeVar == "" || emailVar == "" || cpfVar == "" || nivelVar == "#") {
            descCardErro.innerHTML = "Preencha todos os campos."
            usoCardMensagemErro()

            return
        }

        if (!emailRegex.test(emailVar)) {
            descCardErro.innerHTML = "Insira um e-mail válido."
            usoCardMensagemErro()

            return
        }

        // Validação da senha
        if (senhaVar.length < 8) {
            descCardErro.innerHTML = "A senha deve ter pelo menos 8 caracteres."
            usoCardMensagemErro()

            return
        }

        // Validação do CPF
        if (!cpfRegex.test(cpfVar)) {
            descCardErro.innerHTML = "Insira um CPF válido com 11 dígitos."
            usoCardMensagemErro()

            return
        }


        fetch("/usuarios/cadastrar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                nomeServer: nomeVar,
                emailServer: emailVar,
                senhaServer: senhaVar,
                cpfServer: cpfVar,
                nivelServer: nivelVar,
                fkEmpresa: idEmpresa
            }),
        }).then(function (resposta) {
            console.log("resposta: ", resposta);

            if (resposta.ok) {

                resposta.json()
                    .then(json => {
                        console.log("\n\n\n\n\nALEATÓRIO PARA VER A RESPOSTA");
                        console.log(json);

                    });

                usoCardMensagemSucesso()
                descCardSucesso.innerHTML = `Usuário adicionado`

                setTimeout(() => {
                    fecharModalAddUser();
                }, "1000");


            } else {
                console.log(resposta);
                throw "Houve um erro ao tentar realizar o cadastro! TO NO FUNCIONARIO.HTML";
            }

        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
            return false;
        });

    }

    let idUsuario;

    function abrirModalEditADM(idUser) {
        modalEditUser.style.display = 'block';
        const frame = document.getElementById('frame');
        frame.classList.add('blur-grid')
        idUsuario = idUser;
        fetch(`/usuarios/infoUsuario/${idUsuario}`, {
            method: "GET",
        })
            .then(function (resposta) {
                resposta.json().then((usuario) => {

                    usuario.forEach((registroEU) => {

                        nomeFuncEdit.value = registroEU.nomeUsuario
                        emailFuncEdit.value = registroEU.emailUsuario
                        senhaFuncEdit.value = registroEU.senha
                        cpfFuncEdit.value = registroEU.cpfUsuario
                        selectNvEdit.value = registroEU.idTipoUsuario

                    });
                });
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    function editarUsuario() {

        var nomeVar = nomeFuncEdit.value;
        var emailVar = emailFuncEdit.value;
        var cpfVar = cpfFuncEdit.value;
        var senhaVar = senhaFuncEdit.value;
        var tipoUsuarioVar = selectNvEdit.value;

        console.log(idUsuario);

        if (nomeVar == "" || emailVar == "" || cpfVar == "") {
            descCardErro.innerHTML = "Preencha todos os campos."
            usoCardMensagemErro()

        } else if (!emailRegex.test(emailVar)) {
            descCardErro.innerHTML = "Insira um e-mail válido."
            usoCardMensagemErro()

        } else if (senhaVar.length < 8) {
            descCardErro.innerHTML = "A senha deve ter pelo menos 8 caracteres."
            usoCardMensagemErro()

        } else if (!cpfRegex.test(cpfVar)) {
            descCardErro.innerHTML = "Insira um CPF válido com 11 dígitos."
            usoCardMensagemErro()

        } else {
            fetch(`/usuarios/editarUsuarioADM/${idUsuario}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    emailServer: emailVar,
                    nomeServer: nomeVar,
                    senhaServer: senhaVar,
                    cpfServer: cpfVar,
                    tipoUsuarioServer: tipoUsuarioVar
                }),
            }).then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {


                    usoCardMensagemSucesso()
                    descCardSucesso.innerHTML = `Edição realizada`



                } else {
                    console.log(resposta);
                    throw "Houve um erro ao tentar realizar a edição!";
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
                return false;
            });
        }

    }

    function removerUsuario(idUser) {
        idUsuario = idUser
        console.log(idUsuario);
        fetch(`/usuarios/removerUsuario/${idUsuario}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
            }
        }).then(function (resposta) {
            console.log("resposta: ", resposta);

            if (resposta.ok) {
                usoCardMensagemSucesso()
                descCardSucesso.innerHTML = `Usuário removido`
            } else {
                console.log(resposta);
                throw "Houve um erro ao tentar realizar a edição!";
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
            return false;
        });
    }


    // Funções de card de alerta

    // esse é o id = descCardSucesso para innerHTML a mensagem de sucesso
    function abrirCardSucesoMensagem() {

        const card = document.getElementById("cardSucessoMsg");
        card.classList.remove("fecharCardMensagem");
        card.classList.add("abriCardMensagem");
    }
    function fecharCardSucessoMensagem() {
        const card = document.getElementById("cardSucessoMsg");
        card.classList.remove("abriCardMensagem");
        card.classList.add("fecharCardMensagem");
    }
    // esse é o id = descCardErro para innerHTML a mensagem de sucesso
    function fecharCardErroMensagem() {
        const card = document.getElementById("cardErroMsg");
        card.classList.remove("abriCardMensagem");
        card.classList.add("fecharCardMensagem");
    }
    function abrirCardErroMensagem() {
        const card = document.getElementById("cardErroMsg");
        card.classList.remove("fecharCardMensagem");
        card.classList.add("abriCardMensagem");
    }
    function usoCardMensagemErro() {
        abrirCardErroMensagem();
        setTimeout(() => {
            fecharCardErroMensagem();
        }, "7000");
    }
    function usoCardMensagemSucesso() {
        abrirCardSucesoMensagem();
        setTimeout(() => {
            fecharCardSucessoMensagem();
        }, "7000");
    }


</script>